<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pluvi√¥metro Agr√≠cola Inteligente</title>
    <!-- Inclui a biblioteca Chart.js para desenhar os gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        /* Reset B√°sico e Fontes */
        body {
            font-family: 'Inter', sans-serif; /* Usando uma fonte moderna */
            background-color: #f4f7f6; /* Fundo suave */
            margin: 0;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        /* Cabe√ßalho */
        header {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            border-left: 5px solid #1a6f20; /* Destaque verde */
        }

        header h1 {
            color: #1a6f20; /* Verde escuro */
            font-size: 1.8em;
            font-weight: 700;
            margin: 0;
        }

        header p {
            color: #777;
            font-size: 0.9em;
            margin-left: auto; /* Alinha a data/hora √† direita */
        }

        /* Layout do Dashboard (Grid Responsivo) */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 colunas em desktop */
            gap: 20px;
        }

        /* Adaptando para Tablet e Mobile */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr; /* 1 coluna em mobile */
            }
            /* Os cart√µes de gr√°ficos ocupam a largura total em mobile */
            .chart-card {
                grid-column: 1 / -1;
            }
        }

        /* Cart√µes (Containers Visuais) */
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .data-card h2 {
            font-size: 1em;
            color: #555;
            margin-top: 0;
            font-weight: 500;
        }

        .data-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin: 5px 0 0;
        }

        /* Cores espec√≠ficas para cart√µes de dados */
        .data-card.umidade { border-bottom: 4px solid #c69542; }
        .data-card.chuva { border-bottom: 4px solid #0077b6; }
        .data-card.api-status { border-bottom: 4px solid #1a6f20; }

        .data-card.umidade .data-value {
            color: #c69542; /* Marrom para Umidade do Solo */
        }
        .data-card.chuva .data-value {
            color: #0077b6; /* Azul para Volume de Chuva */
        }
        .data-card.api-status .data-value {
            font-size: 2em;
            color: #1a6f20;
        }

        /* Estilos din√¢micos para o estado do solo */
        .data-label {
            font-size: 0.8em;
            color: #999;
            margin-top: 10px;
        }
        
        .data-label.status-ok { color: #1a6f20; font-weight: 600; }
        .data-label.status-warning { color: #c69542; font-weight: 600; }
        .data-label.status-alert { color: #dc3545; font-weight: 600; }


        /* Gr√°ficos */
        .chart-card {
            grid-column: 1 / span 3; /* Ocupa 3 colunas em desktop */
            height: 400px; /* Altura fixa para o gr√°fico */
            display: flex;
            flex-direction: column;
        }

        .chart-card h2 {
            margin-bottom: 15px;
            color: #1a6f20;
            font-size: 1.4em;
        }

        /* Cont√™iner do Canvas para responsividade */
        .chart-container {
            flex-grow: 1;
            position: relative;
        }

        /* Estiliza√ß√£o do √≠cone no header */
        header svg {
            display: inline-block; 
            vertical-align: middle; 
            margin-right: 15px;
            width: 30px;
            height: 30px;
        }
    </style>
</head>
<body onload="initDashboard()">
    <header>
        <!-- Icone de Nuvem/Gota -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1a6f20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v6"/><path d="m12 18-4 4"/><path d="m12 22 4-4"/><path d="M16 16.5c-1.52.86-3.23.86-4.88 0-1.76-1-2.92-2.92-2.92-5.11 0-4.63 3.65-8.47 8.24-8.87 3.51-.31 6.84 1.48 8.48 4.67 1.48 2.87.97 6.44-1.39 8.74"/></svg>
        <h1>Pluvi√¥metro Agr√≠cola Inteligente</h1>
        <p>Dados atualizados em: <span id="data-hora">--:--</span></p>
    </header>

    <main class="dashboard">
        <!-- Cart√£o 1: Umidade do Solo -->
        <div class="card data-card umidade">
            <h2>Umidade do Solo</h2>
            <p class="data-value" id="umidade-valor">-- %</p>
            <p class="data-label" id="estado-solo">Aguardando leitura...</p>
        </div>
        
        <!-- Cart√£o 2: Volume de Chuva -->
        <div class="card data-card chuva">
            <h2>Chuva Acumulada (√öltimos 7 Dias)</h2>
            <p class="data-value" id="chuva-valor">-- mm</p>
            <p class="data-label">Total estimado</p>
        </div>

        <!-- Cart√£o 3: Status da API/Conex√£o -->
        <div class="card data-card api-status">
            <h2>Status do Sistema</h2>
            <p class="data-value" id="api-status-icon">‚ö™</p>
            <p class="data-label" id="api-status-text">Inicializando...</p>
        </div>


        <!-- Gr√°fico 1: Hist√≥rico de Umidade (√öltimas 24 horas) -->
        <div class="card chart-card" style="grid-column: 1 / span 2;">
            <h2>Hist√≥rico de Umidade (√öltimas 24h)</h2>
            <div class="chart-container">
                <canvas id="umidadeChart"></canvas>
            </div>
        </div>
        
        <!-- Gr√°fico 2: Chuva Semanal -->
        <div class="card chart-card" style="grid-column: 3 / span 1;">
            <h2>Chuva por Dia (√öltimos 7 Dias)</h2>
            <div class="chart-container">
                <canvas id="chuvaChart"></canvas>
            </div>
        </div>
    </main>

    <script>
        // ATEN√á√ÉO: Altera√ß√£o feita para funcionar em ambientes de nuvem como o Render.
        // O caminho da API agora √© RELATIVO ao dom√≠nio do dashboard.
        const API_URL = 'https://pluviometro-api.onrender.com';
        
        const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        let umidadeChartInstance = null;
        let chuvaChartInstance = null;

        // ===============================================
        // FUN√á√ïES DE STATUS E VALIDA√á√ÉO
        // ===============================================

        /**
         * Atualiza o cart√£o de status da API.
         * @param {boolean} isOk - True se a conex√£o foi bem sucedida.
         */
        function updateApiStatus(isOk) {
            const icon = document.getElementById('api-status-icon');
            const text = document.getElementById('api-status-text');
            
            if (isOk) {
                icon.textContent = 'üü¢';
                text.textContent = 'Conex√£o OK';
                icon.style.color = '#1a6f20'; // Verde
            } else {
                icon.textContent = 'üî¥';
                text.textContent = 'Erro de Conex√£o (Verificar API)';
                icon.style.color = '#dc3545'; // Vermelho
            }
        }
        
        /**
         * Atualiza o status do solo baseado na umidade.
         * @param {number} umidade - Valor de umidade do solo.
         */
        function updateEstadoSolo(umidade) {
            const estadoElement = document.getElementById('estado-solo');
            estadoElement.className = 'data-label'; // Reset classes

            if (umidade >= 70) {
                estadoElement.textContent = 'Solo √ömido (Excelente)';
                estadoElement.classList.add('status-ok');
            } else if (umidade > 30) {
                estadoElement.textContent = 'N√≠vel Ideal para Cultivo';
                estadoElement.classList.add('status-warning');
            } else {
                estadoElement.textContent = 'Solo Seco, Requer Irriga√ß√£o!';
                estadoElement.classList.add('status-alert');
            }
        }


        // ===============================================
        // FUN√á√ïES DE BUSCA (FETCH)
        // ===============================================

        async function buscarUltimaLeitura() {
            try {
                // A requisi√ß√£o usa o caminho relativo '/api/ultima_leitura'
                const response = await fetch(`${API_URL}/ultima_leitura`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                updateApiStatus(true);
                const data = await response.json();

                // 1. Atualiza os cart√µes
                const umidade = parseFloat(data.umidade_solo);
                document.getElementById('umidade-valor').textContent = `${umidade.toFixed(0)} %`;
                document.getElementById('chuva-valor').textContent = `${parseFloat(data.volume_chuva).toFixed(1)} mm`;
                
                // 2. Formata e atualiza a data/hora
                const dataLeitura = new Date(data.data_hora);
                const horaMinuto = dataLeitura.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('data-hora').textContent = horaMinuto;

                // 3. Atualiza o estado do solo
                updateEstadoSolo(umidade);

            } catch (error) {
                console.error("Erro ao buscar √∫ltima leitura:", error);
                // Atualiza o status da API para erro
                updateApiStatus(false);
            }
        }

        async function buscarDadosChuva() {
            try {
                const response = await fetch(`${API_URL}/chuva_semanal`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                updateApiStatus(true);
                const dados = await response.json();
                
                // Formata os dados
                const labels = dados.map(item => diasSemana[item.dia_semana_num]);
                const volumes = dados.map(item => parseFloat(item.volume_total));

                renderizarChuvaChart(labels, volumes);
            } catch (error) {
                console.error("Erro ao buscar dados de chuva:", error);
                // Atualiza o status da API para erro se for a primeira falha
                updateApiStatus(false); 
            }
        }

        async function buscarDadosUmidade() {
            try {
                const response = await fetch(`${API_URL}/historico_umidade`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                updateApiStatus(true);
                const dados = await response.json();
                
                // Formata os dados: a API j√° agrupa por 4 horas, basta usar os campos
                const labels = dados.map(item => item.hora_agrupada);
                const umidades = dados.map(item => parseFloat(item.umidade_media));

                renderizarUmidadeChart(labels, umidades);
            } catch (error) {
                console.error("Erro ao buscar hist√≥rico de umidade:", error);
                // Atualiza o status da API para erro se for a primeira falha
                updateApiStatus(false);
            }
        }

        // ===============================================
        // FUN√á√ïES DE RENDERIZA√á√ÉO (CHART.JS)
        // ===============================================

        function renderizarChuvaChart(labels, volumes) {
            if (chuvaChartInstance) chuvaChartInstance.destroy(); // Destr√≥i o anterior
            const ctx = document.getElementById('chuvaChart').getContext('2d');
            chuvaChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels, 
                    datasets: [{
                        label: 'Volume (mm)',
                        data: volumes,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)', // Azul
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'mm' } },
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function renderizarUmidadeChart(labels, umidades) {
            if (umidadeChartInstance) umidadeChartInstance.destroy(); // Destr√≥i o anterior
            const ctx = document.getElementById('umidadeChart').getContext('2d');
            umidadeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, 
                    datasets: [{
                        label: 'Umidade (%)',
                        data: umidades,
                        borderColor: '#c69542', // Marrom/Dourado 
                        tension: 0.4, 
                        fill: false,
                        pointRadius: 5, // Pontos maiores
                        pointBackgroundColor: '#c69542'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, max: 100, title: { display: true, text: 'Umidade (%)' } },
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // ===============================================
        // INICIALIZA√á√ÉO E REPETI√á√ÉO
        // ===============================================
        function initDashboard() {
            // Busca e atualiza os dados imediatamente
            buscarUltimaLeitura();
            buscarDadosChuva();
            buscarDadosUmidade();
            
            // Atualiza os cart√µes mais frequentemente (a cada 60 segundos)
            setInterval(buscarUltimaLeitura, 60000); 
            // Atualiza os gr√°ficos menos frequentemente (a cada 5 minutos)
            setInterval(buscarDadosChuva, 300000); 
            setInterval(buscarDadosUmidade, 300000); 
        }
    </script>
</body>

</html>
