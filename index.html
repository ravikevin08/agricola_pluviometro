<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pluviômetro Agrícola Inteligente</title>
    <!-- Inclui a biblioteca Chart.js para desenhar os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        /* Reset Básico e Fontes */
        body {
            font-family: 'Inter', sans-serif; /* Usando uma fonte moderna */
            background-color: #f4f7f6; /* Fundo suave */
            margin: 0;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        /* Cabeçalho */
        header {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            border-left: 5px solid #1a6f20; /* Destaque verde (Cor da agricultura) */
        }

        header h1 {
            color: #1a6f20; /* Verde escuro */
            font-size: 1.8em;
            font-weight: 600;
            margin: 0;
            margin-left: 10px;
        }

        header p {
            color: #777;
            font-size: 0.9em;
            margin-left: auto; /* Alinha a data/hora à direita */
            font-weight: 500;
        }

        /* Layout do Dashboard (Grid Responsivo) */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr; /* 1 coluna para mobile */
            gap: 20px;
        }

        @media (min-width: 768px) {
            .dashboard {
                grid-template-columns: repeat(3, 1fr); /* 3 colunas em desktop */
            }
            .chart-card-full {
                grid-column: 1 / span 3; /* Ocupa 3 colunas */
            }
            .chart-card-half {
                grid-column: span 2; /* Histórico de Umidade (2/3) */
            }
            .chart-card-third {
                grid-column: span 1; /* Chuva Semanal (1/3) */
            }
        }
        
        /* Cartões (Containers Visuais) */
        .card {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            /* Garante que o conteúdo seja cortado se o gráfico for maior */
            overflow: hidden; 
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .data-card h2 {
            font-size: 0.9em;
            color: #555;
            margin-top: 0;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin: 5px 0 0;
        }

        .data-card.umidade .data-value {
            color: #c69542; /* Marrom para Umidade do Solo */
        }
        .data-card.chuva .data-value {
            color: #0077b6; /* Azul para Volume de Chuva */
        }
        .data-card.status {
            border-left: 5px solid gray; /* Padrão antes de carregar */
        }

        .data-label {
            font-size: 0.8em;
            color: #999;
        }

        /* Gráficos */
        .chart-container {
            position: relative;
            height: 300px; /* Altura fixa para os gráficos */
        }
    </style>
</head>
<body onload="initDashboard()">
    <header>
        <!-- Icone de Nuvem (Lucide Icon, usado para representar clima/agricultura) -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1a6f20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle;"><path d="M12 2v6"/><path d="m12 18-4 4"/><path d="m12 22 4-4"/><path d="M16 16.5c-1.52.86-3.23.86-4.88 0-1.76-1-2.92-2.92-2.92-5.11 0-4.63 3.65-8.47 8.24-8.87 3.51-.31 6.84 1.48 8.48 4.67 1.48 2.87.97 6.44-1.39 8.74"/></svg>
        <h1>Pluviômetro Agrícola Inteligente</h1>
        <p>Dados atualizados em: <span id="data-hora">--:--</span></p>
    </header>

    <main class="dashboard">
        <!-- Cartão 1: Umidade do Solo -->
        <div class="card data-card umidade">
            <h2>Umidade do Solo Atual</h2>
            <p class="data-value" id="umidade-valor">-- %</p>
            <p class="data-label">Última leitura registrada</p>
        </div>
        
        <!-- Cartão 2: Volume de Água -->
        <div class="card data-card chuva">
            <h2>Chuva Acumulada (24h)</h2>
            <p class="data-value" id="chuva-valor">-- mm</p>
            <p class="data-label">Últimas 24 horas</p>
        </div>

        <!-- Cartão 3: Status da API/Banco -->
        <div class="card data-card status" id="status-card">
            <h2>Status da Conexão API</h2>
            <p class="data-value" id="status-valor" style="font-size: 1.8em; color: gray;">Carregando...</p>
            <p class="data-label">API: https://pluviometro-api.onrender.com</p>
        </div>

        <!-- Gráfico 4: Histórico de Umidade (24h) - Ocupa 2 colunas -->
        <div class="card chart-card-half">
            <h2>Umidade Média do Solo (Últimas 24h)</h2>
            <div class="chart-container">
                <canvas id="umidadeChart"></canvas>
            </div>
        </div>

        <!-- Gráfico 3: Histórico de Chuva Semanal - Ocupa 1 coluna -->
        <div class="card chart-card-third">
            <h2>Volume de Chuva Semanal (mm)</h2>
            <div class="chart-container">
                <canvas id="chuvaChart"></canvas>
            </div>
        </div>
    </main>

    <script>
        // ===============================================
        // CONFIGURAÇÃO DA API (ATUALIZADA PARA O RENDER)
        // ===============================================
        // ATENÇÃO: A URL AGORA APONTA PARA SEU SERVIÇO DEPLOYADO NO RENDER!
        const API_URL = 'https://pluviometro-api.onrender.com/api'; 
        
        // Mapeamento dos dias da semana (PostgreSQL retorna 0=Dom, 1=Seg...)
        const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
        
        let umidadeChartInstance = null;
        let chuvaChartInstance = null;

        // Função utilitária para atualizar o status de conexão
        function updateStatus(isOk) {
            const statusValor = document.getElementById('status-valor');
            const statusCard = document.getElementById('status-card');
            
            if (isOk) {
                statusValor.textContent = 'CONECTADO OK';
                statusValor.style.color = '#1a6f20'; // Verde
                statusCard.style.borderLeftColor = '#1a6f20';
            } else {
                statusValor.textContent = 'ERRO';
                statusValor.style.color = '#dc3545'; // Vermelho
                statusCard.style.borderLeftColor = '#dc3545';
            }
        }

        // ===============================================
        // FUNÇÕES DE BUSCA (FETCH)
        // ===============================================

        async function buscarUltimaLeitura() {
            try {
                const response = await fetch(`${API_URL}/ultima_leitura`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                // 1. Atualiza os cartões
                document.getElementById('umidade-valor').textContent = `${data.umidade_solo} %`;
                document.getElementById('chuva-valor').textContent = `${data.volume_chuva} mm`;
                
                // 2. Formata e atualiza a data/hora
                const dataLeitura = new Date(data.data_hora);
                const horaMinuto = dataLeitura.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const diaMes = dataLeitura.toLocaleDateString('pt-BR');
                document.getElementById('data-hora').textContent = `${diaMes} ${horaMinuto}`;
                
                updateStatus(true); // Conexão bem-sucedida

            } catch (error) {
                console.error("Erro ao buscar a última leitura:", error);
                document.getElementById('umidade-valor').textContent = `-- %`;
                document.getElementById('chuva-valor').textContent = `-- mm`;
                document.getElementById('data-hora').textContent = `Falha ao conectar`;
                updateStatus(false); // Erro de conexão
            }
        }

        async function buscarDadosUmidade() {
            try {
                const response = await fetch(`${API_URL}/historico_umidade`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const dadosUmidade = await response.json();
                
                // Extrai rótulos (horas) e dados (umidade)
                const labels = dadosUmidade.map(d => d.hora_agrupada);
                const umidades = dadosUmidade.map(d => parseFloat(d.umidade_media));

                renderizarUmidadeChart(labels, umidades);
                updateStatus(true);

            } catch (error) {
                console.error("Erro ao buscar histórico de umidade:", error);
                updateStatus(false);
            }
        }

        async function buscarDadosChuva() {
            try {
                const response = await fetch(`${API_URL}/chuva_semanal`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const dadosChuva = await response.json();

                // 1. O backend já retorna a soma agrupada, precisamos apenas extrair os dados na ordem correta
                // A query retorna os dias na ordem numérica (0=Dom, 1=Seg...)
                const finalLabels = dadosChuva.map(item => diasSemana[item.dia_semana_num]);
                const finalData = dadosChuva.map(item => parseFloat(item.volume_total));

                renderizarChuvaChart(finalLabels, finalData);
                updateStatus(true);

            } catch (error) {
                console.error("Erro ao buscar dados de chuva:", error);
                updateStatus(false);
            }
        }

        // ===============================================
        // FUNÇÕES DE RENDERIZAÇÃO DE GRÁFICOS
        // ===============================================

        function renderizarUmidadeChart(labels, umidades) {
            const ctx = document.getElementById('umidadeChart').getContext('2d');
            
            // Destruir instância anterior, se existir
            if (umidadeChartInstance) {
                umidadeChartInstance.destroy();
            }

            umidadeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, 
                    datasets: [{
                        label: 'Umidade (%)',
                        data: umidades,
                        borderColor: '#c69542', // Marrom/Dourado 
                        tension: 0.4, 
                        fill: true, // Preenche a área abaixo da linha
                        backgroundColor: 'rgba(198, 149, 66, 0.2)', // Cor de preenchimento
                        pointRadius: 5, 
                        pointBackgroundColor: '#c69542'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            min: 0, 
                            max: 100, 
                            title: { display: true, text: 'Umidade (%)' },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            title: { display: true, text: 'Horário (Agrupado em 4h)' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function renderizarChuvaChart(labels, volumes) {
            const ctx = document.getElementById('chuvaChart').getContext('2d');
            
            // Destruir instância anterior, se existir
            if (chuvaChartInstance) {
                chuvaChartInstance.destroy();
            }

            chuvaChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels, 
                    datasets: [{
                        label: 'Chuva (mm)',
                        data: volumes,
                        backgroundColor: '#0077b6', // Azul para Chuva
                        borderColor: '#005f93',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Volume (mm)' },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // ===============================================
        // INICIALIZAÇÃO E REPETIÇÃO
        // ===============================================
        function initDashboard() {
            // Busca e atualiza os dados imediatamente
            buscarUltimaLeitura();
            buscarDadosChuva();
            buscarDadosUmidade();
            
            // Atualiza os cartões mais frequentemente (a cada 60 segundos)
            setInterval(buscarUltimaLeitura, 60000); 
            // Atualiza os gráficos menos frequentemente (a cada 5 minutos)
            setInterval(buscarDadosChuva, 300000); 
            setInterval(buscarDadosUmidade, 300000); 
        }
    </script>
</body>
</html>

